DROP DATABASE IF EXISTS vbeat; 
CREATE DATABASE Vbeat;
USE Vbeat;

CREATE TABLE `user`(
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,email VARCHAR(100) NOT NULL
    ,loginPw VARCHAR(255) NULL
    ,nickName VARCHAR(50) NOT NULL
    ,loginType TINYINT NOT NULL DEFAULT 0 COMMENT '0=ÏùºÎ∞ò, 1=Ïπ¥Ïπ¥Ïò§, 2=Íµ¨Í∏Ä'
    ,socialId VARCHAR(80) NULL
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,profileImg VARCHAR(255) NULL
    ,`role` VARCHAR(15) NOT NULL DEFAULT 'USER'  # USER = ÏùºÎ∞ò ÌöåÏõê, ADMIN = Í¥ÄÎ¶¨Ïûê , BLOCK = Ï∞®Îã® Í≥ÑÏ†ï
    ,UNIQUE KEY (email)
    ,UNIQUE KEY (nickName)
);

DROP TABLE `user`;
SELECT * FROM `user`;

# Ï∂îÌõÑ Ïª¨Îüº ÏàòÏ†ï 
CREATE TABLE Message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,channelId INT UNSIGNED NOT NULL 
    ,userId  INT UNSIGNED
    ,content TEXT NOT NULL 
    ,`type` INT UNSIGNED DEFAULT 0 # 0=ÏùºÎ∞ò, 1=ÏãúÏä§ÌÖú, 2=ÌååÏùº, 3=Git, 4=ÏΩîÎìú
    ,filtered TINYINT(1) NOT NULL DEFAULT 0     -- ‚úÖ Ï∂îÍ∞Ä
    ,filter_type VARCHAR(20) NULL               -- ‚úÖ Ï∂îÍ∞Ä
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,FOREIGN KEY (channelId) REFERENCES `Channel`(id) ON DELETE CASCADE
    ,FOREIGN KEY (userId) REFERENCES `User`(id) ON DELETE SET NULL
)


# ÏùåÏõê Í¥ÄÎ†® ÌÖåÏù¥Î∏î
CREATE TABLE song(
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
    ,user_Id INT UNSIGNED NOT NULL 
    ,title VARCHAR(100) NOT NULL
    ,artist VARCHAR(100) NOT NULL
    ,duration VARCHAR(200) NOT NULL
    ,diff ENUM('easy','normal','hard','hell') NOT NULL DEFAULT 'normal'
    ,file_path VARCHAR(500) NULL
    ,create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,cover_path VARCHAR(500) NULL
    ,preview_path VARCHAR(500) NULL
    ,visibility ENUM('PRIVATE','UNLISTED','PENDING','PUBLIC','BLOCKED') NOT NULL DEFAULT 'PRIVATE'
    ,FOREIGN KEY (user_Id) REFERENCES `user`(id) ON DELETE CASCADE 
);

SELECT * FROM song;
DROP TABLE song;

UPDATE song
   SET is_public = TRUE
 WHERE id IN (9); 
 
SELECT note_time, lane, TYPE, end_time, COUNT(*)
FROM note
WHERE song_id = 6
GROUP BY note_time, lane, TYPE, end_time
HAVING COUNT(*) > 1;


# ÏùåÏõêÎ∂ÑÏÑù ÌõÑ ÎÖ∏Ìä∏ Ï†ÄÏû• ÌÖåÏù¥Î∏î
CREATE TABLE note (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    song_id BIGINT UNSIGNED NOT NULL,
    note_time DECIMAL(10,3) NOT NULL,   -- FlaskÏóêÏÑú 3ÏûêÎ¶¨Î°ú ÎùºÏö¥Îî©Îêú time
    lane TINYINT UNSIGNED NOT NULL,
    `type` ENUM('tap', 'long') NOT NULL DEFAULT 'tap',
    end_time DECIMAL(10,3) NULL,        -- longÎßå ÏÇ¨Ïö©, tapÏùÄ NULL
    -- tap/end_time NULL Î¨∏Ï†ú Ìï¥Í≤∞Ïö© (Ï§ëÎ≥µ Î∞©ÏßÄ ÌïµÏã¨)
    end_time_nn DECIMAL(10,3)
        GENERATED ALWAYS AS (IFNULL(end_time, -1.000)) STORED,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    -- Ï°∞ÌöåÏö© Ïù∏Îç±Ïä§
    INDEX idx_song_time (song_id, note_time),
    INDEX idx_song_end (song_id, end_time),
    -- üîí ÏµúÏ¢Ö Ï§ëÎ≥µ Ï∞®Îã® (Í∞ôÏùÄ ÏãúÍ∞Å/Î†àÏù∏/ÌÉÄÏûÖ ÎÖ∏Ìä∏ Ï†àÎåÄ Î∂àÍ∞Ä)
    UNIQUE KEY uq_note_dedup (song_id, note_time, lane, `type`, end_time_nn)
);

DROP TABLE note
SELECT * FROM note;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# Ï†êÏàò Ï†ÄÏû• ÌÖåÏù¥Î∏î(Îû≠ÌÇπÏãúÏä§ÌÖú)
CREATE TABLE score (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    userId BIGINT UNSIGNED NOT NULL,  #Ï∂îÌõÑ Î°úÍ∑∏Ïù∏ Í∏∞Îä• Íµ¨ÌòÑ Ïãú not nullÎ°ú Î≥ÄÍ≤Ω
    songid BIGINT UNSIGNED NOT NULL,
    diff VARCHAR(10) NOT NULL,
    score INT NOT NULL,
    accuracy DECIMAL(5,2) NOT NULL,
    grade CHAR(1) NOT NULL,
    max_combo INT NOT NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_rank (song_id, diff, score, accuracy, max_combo, reg_date),
    INDEX idx_user (user_id, song_id, diff)
);

SELECT * FROM score;
DROP TABLE score;


# ÏπúÍµ¨ Ï∂îÍ∞Ä Í¥ÄÎ†® ÌÖåÏù¥Î∏î
CREATE TABLE FriendRequest (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fromUserId INT NOT NULL COMMENT 'ÏπúÍµ¨ ÏöîÏ≤≠ Î≥¥ÎÇ∏ Ïú†Ï†Ä',
    toUserId INT NOT NULL COMMENT 'ÏπúÍµ¨ ÏöîÏ≤≠ Î∞õÏùÄ Ïú†Ï†Ä',
    STATUS TINYINT NOT NULL COMMENT '0=ÏöîÏ≤≠Ï§ë, 1=ÏπúÍµ¨',
    regDate DATETIME NOT NULL DEFAULT NOW(),
    updateDate DATETIME NOT NULL DEFAULT NOW() ON UPDATE NOW(),

    UNIQUE KEY uq_from_to (fromUserId, toUserId),
    INDEX idx_to_status (toUserId, STATUS),
    INDEX idx_from_status (fromUserId, STATUS)
);


CREATE TABLE private_message (
  id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
  fromUserId INT UNSIGNED NOT NULL,
  to_user_id INT UNSIGNED NOT NULL,
  title   VARCHAR(120) NULL,
  content TEXT NOT NULL,
  filtered TINYINT(1) NOT NULL DEFAULT 0,     -- ‚úÖ Ï∂îÍ∞Ä
  filter_type VARCHAR(20) NULL,               -- ‚úÖ Ï∂îÍ∞Ä
  is_read TINYINT(1) NOT NULL DEFAULT 0,
  readDate DATETIME NULL,
  regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idxToReadDate (to_user_id, is_read, regDate),
  INDEX idxFromDate (fromUserId, regDate),
  
  FOREIGN KEY (fromUserId) REFERENCES `user`(id) ON DELETE CASCADE,
  FOREIGN KEY (to_user_id)   REFERENCES `user`(id) ON DELETE CASCADE
);

SELECT * FROM private_message;
DROP TABLE private_message;


# Ïã†Í≥† Ï†ëÏàò ÌÖåÏù¥Î∏î
CREATE TABLE report (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    reporter_user_id INT(10) UNSIGNED NOT NULL,
    target_type ENUM('USER', 'SONG', 'COMMENT') NOT NULL,
    target_id BIGINT UNSIGNED NOT NULL,
    reason_code VARCHAR(30) NOT NULL,
    `description` TEXT,
    # pending = Ï†ëÏàò, resolved = Ï≤òÎ¶¨ ÏôÑÎ£å, rejected = Í∏∞Í∞Å/Î¨∏Ï†úÏóÜÏùå
    STATUS ENUM('PENDING', 'RESOLVED', 'REJECTED') NOT NULL DEFAULT 'PENDING',
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_report_reporter
        FOREIGN KEY (reporter_user_id)
        REFERENCES USER(id)
        ON DELETE CASCADE,
    INDEX idx_report_pending
    (reporter_user_id, target_type, target_id, reason_code, `status`)
);

SELECT * FROM report;
DROP TABLE report;


# Ïã†Í≥†Ïóê ÎåÄÌïú Í¥ÄÎ¶¨Ïûê Ï°∞Ïπò ÌÖåÏù¥Î∏î
CREATE TABLE report_action (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    report_id BIGINT UNSIGNED NOT NULL,
    admin_id INT UNSIGNED NULL,
    # warn = Í≤ΩÍ≥†, block = Ï∞®Îã®, delete_content = Ïª®ÌÖêÏ∏† ÏÇ≠Ï†ú, ignore = Î∞òÎ†§
    action_type ENUM('WARN','BLOCK','DELETE_CONTENT','IGNORE') NOT NULL,
    action_reason TEXT,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_report_action_report
        FOREIGN KEY (report_id)
        REFERENCES report(id)
        ON DELETE CASCADE,

    CONSTRAINT fk_report_action_admin
        FOREIGN KEY (admin_id)
        REFERENCES `user`(id)
        ON DELETE SET NULL
);

SELECT * FROM report_action;
DROP TABLE report_action;


# Ïã†Í≥† ÎãπÏãú ÎÇ¥Ïö© Î≥¥Ï°¥ ÌÖåÏù¥Î∏î
CREATE TABLE report_target_snapshot (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    report_id BIGINT UNSIGNED NOT NULL,
    target_name VARCHAR(100) NOT NULL,
    target_extra JSON,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_snapshot_report
        FOREIGN KEY (report_id)
        REFERENCES report(id)
        ON DELETE CASCADE
);

SELECT * FROM report_target_snapshot;
DROP TABLE report_target_snapshot;