CREATE DATABASE Vbeat;
USE Vbeat;

# 유저 정보 테이블
CREATE TABLE `User`(
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,email VARCHAR(100) NOT NULL
    ,loginPw VARCHAR(255) NULL
    ,nickName VARCHAR(50) NOT NULL
    ,loginType TINYINT NOT NULL DEFAULT 0 COMMENT '0=일반, 1=카카오, 2=구글'
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,profileImg VARCHAR(255) NULL
    ,UNIQUE KEY (email)
    ,UNIQUE KEY (nickName)
);


# 추후 컬럼 수정 
CREATE TABLE Message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,channelId INT UNSIGNED NOT NULL 
    ,userId  INT UNSIGNED
    ,content TEXT NOT NULL 
    ,`type` INT UNSIGNED DEFAULT 0 # 0=일반, 1=시스템, 2=파일, 3=Git, 4=코드
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,FOREIGN KEY (channelId) REFERENCES `Channel`(id) ON DELETE CASCADE
    ,FOREIGN KEY (userId) REFERENCES `User`(id) ON DELETE SET NULL
)


# 음원 관련 테이블
CREATE TABLE song(
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    artist VARCHAR(100) NOT NULL,
    duration VARCHAR(200) NOT NULL,
    diff ENUM('easy','normal','hard','hell') NOT NULL DEFAULT 'normal',
    file_path VARCHAR(500) NULL,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    cover_path VARCHAR(500) NULL,
    is_public BOOLEAN NOT NULL DEFAULT FALSE
);

SELECT * FROM song;
DROP TABLE song;

UPDATE song
   SET is_public = TRUE
 WHERE id IN (1,2,3,4); 
 
SELECT note_time, lane, TYPE, end_time, COUNT(*)
FROM note
WHERE song_id = 6
GROUP BY note_time, lane, TYPE, end_time
HAVING COUNT(*) > 1;


# 음원분석 후 노트 저장 테이블
CREATE TABLE note (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    song_id BIGINT UNSIGNED NOT NULL,
    note_time DECIMAL(10,3) NOT NULL,   -- Flask에서 3자리로 라운딩된 time
    lane TINYINT UNSIGNED NOT NULL,
    `type` ENUM('tap', 'long') NOT NULL DEFAULT 'tap',
    end_time DECIMAL(10,3) NULL,        -- long만 사용, tap은 NULL
    -- tap/end_time NULL 문제 해결용 (중복 방지 핵심)
    end_time_nn DECIMAL(10,3)
        GENERATED ALWAYS AS (IFNULL(end_time, -1.000)) STORED,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    -- 조회용 인덱스
    INDEX idx_song_time (song_id, note_time),
    INDEX idx_song_end (song_id, end_time),
    -- 🔒 최종 중복 차단 (같은 시각/레인/타입 노트 절대 불가)
    UNIQUE KEY uq_note_dedup (song_id, note_time, lane, `type`, end_time_nn)
);

DROP TABLE note
SELECT * FROM note;


# 점수 저장 테이블(랭킹시스템)
CREATE TABLE score (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NULL,  #추후 로그인 기능 구현 시 not null로 변경
    song_id BIGINT UNSIGNED NOT NULL,
    diff VARCHAR(10) NOT NULL,
    score INT NOT NULL,
    accuracy DECIMAL(5,2) NOT NULL,
    grade CHAR(1) NOT NULL,
    max_combo INT NOT NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_rank (song_id, diff, score, accuracy, max_combo, reg_date),
    INDEX idx_user (user_id, song_id, diff)
);

SELECT * FROM score;
DROP TABLE score;