DROP DATABASE IF EXISTS vbeat;
CREATE DATABASE vbeat;
USE vbeat;

# USER - 사용자 테이블
CREATE TABLE `user` (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(100) NOT NULL,
    login_pw VARCHAR(255) NULL,
    nickName VARCHAR(50) NOT NULL,
    login_type TINYINT NOT NULL DEFAULT 0 COMMENT '0=일반, 1=카카오, 2=구글',
    social_id VARCHAR(80) NULL,
    need_pw_change BOOLEAN NOT NULL DEFAULT FALSE COMMENT '임시 비밀번호 로그인 후 비밀번호 변경 필요 여부',
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    profile_img VARCHAR(255) NOT NULL DEFAULT '/upload/profileImg/default.png',
    `role` VARCHAR(15) NOT NULL DEFAULT 'USER' COMMENT 'USER=일반, ADMIN=관리자, BLOCK=차단',

    UNIQUE KEY uq_user_email (email),
    UNIQUE KEY uq_user_nick (nickName)
);


# MESSAGE (채널 테이블이 아직 없으면 FK는 보류)
CREATE TABLE message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
    channel_id INT UNSIGNED NOT NULL,
    user_id INT UNSIGNED NULL,
    content TEXT NOT NULL,
    `type` INT UNSIGNED DEFAULT 0 COMMENT '0=일반, 1=시스템, 2=파일, 3=Git, 4=코드',
    filtered TINYINT(1) NOT NULL DEFAULT 0,
    filter_type VARCHAR(20) NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_message_channel_date (channel_id, reg_date),
    INDEX idx_message_user_date (user_id, reg_date)

    -- Channel 테이블 생기면 아래 FK 활성화
    -- ,FOREIGN KEY (channel_id) REFERENCES `channel`(id) ON DELETE CASCADE
    -- ,FOREIGN KEY (user_id) REFERENCES `user`(id) ON DELETE SET NULL
);


# SONG - 노래 정보 테이블
CREATE TABLE song (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id INT UNSIGNED NOT NULL,
    title VARCHAR(100) NOT NULL,
    artist VARCHAR(100) NOT NULL,
    duration VARCHAR(200) NOT NULL,
    diff ENUM('easy','normal','hard','hell') NOT NULL DEFAULT 'normal',
    file_path VARCHAR(500) NULL,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    cover_path VARCHAR(500) NULL,
    preview_path VARCHAR(500) NULL,
    visibility ENUM('PRIVATE','UNLISTED','PENDING','PUBLIC','BLOCKED') NOT NULL DEFAULT 'PRIVATE',
    share_token VARCHAR(50) UNIQUE NULL,
    review_reason VARCHAR(255) NULL,
    review_by INT UNSIGNED NULL,
    review_at DATETIME NULL,

    INDEX idx_song_user_date (user_id, create_date),
    INDEX idx_song_visibility (visibility),
    FOREIGN KEY (user_id) REFERENCES `user`(id) ON DELETE CASCADE
);


# NOTE - 노트 정보 테이블
CREATE TABLE note (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    song_id BIGINT UNSIGNED NOT NULL,
    note_time DECIMAL(10,3) NOT NULL,
    lane TINYINT UNSIGNED NOT NULL,
    `type` ENUM('tap', 'long') NOT NULL DEFAULT 'tap',
    end_time DECIMAL(10,3) NULL,

    -- tap/end_time NULL 중복 방지용
    end_time_nn DECIMAL(10,3)
        GENERATED ALWAYS AS (IFNULL(end_time, -1.000)) STORED,

    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_note_song_time (song_id, note_time),
    INDEX idx_note_song_end (song_id, end_time),

    UNIQUE KEY uq_note_dedup (song_id, note_time, lane, `type`, end_time_nn),

    FOREIGN KEY (song_id) REFERENCES song(id) ON DELETE CASCADE
);


# SCORE - 게임 기록 저장 테이블(랭킹시스템)
CREATE TABLE score (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    song_id BIGINT UNSIGNED NOT NULL,
    diff VARCHAR(10) NOT NULL,
    score INT NOT NULL,
    accuracy DECIMAL(5,2) NOT NULL,
    grade CHAR(1) NOT NULL,
    max_combo INT NOT NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_rank (song_id, diff, score, accuracy, max_combo, reg_date),
    INDEX idx_user (user_id, song_id, diff)
);


# FRIEND REQUEST - 친구 요청 테이블
CREATE TABLE friendrequest (
    id INT AUTO_INCREMENT PRIMARY KEY,
    from_user_id INT UNSIGNED NOT NULL COMMENT '친구 요청 보낸 유저',
    to_user_id INT UNSIGNED NOT NULL COMMENT '친구 요청 받은 유저',
    `status` TINYINT NOT NULL COMMENT '0=요청중, 1=친구',
    reg_date DATETIME NOT NULL DEFAULT NOW(),
    update_date DATETIME NOT NULL DEFAULT NOW() ON UPDATE NOW(),

    UNIQUE KEY uq_from_to (from_user_id, to_user_id),
    INDEX idx_to_status (to_user_id, `status`),
    INDEX idx_from_status (from_user_id, `status`),

    FOREIGN KEY (from_user_id) REFERENCES `user`(id) ON DELETE CASCADE,
    FOREIGN KEY (to_user_id) REFERENCES `user`(id) ON DELETE CASCADE
);
DROP TABLE friend_request;

# PRIVATE MESSAGE
CREATE TABLE private_message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
    from_user_id INT UNSIGNED NOT NULL,
    to_user_id INT UNSIGNED NOT NULL,
    title VARCHAR(120) NULL,
    content TEXT NOT NULL,
    filtered TINYINT(1) NOT NULL DEFAULT 0,
    filter_type VARCHAR(20) NULL,
    is_read TINYINT(1) NOT NULL DEFAULT 0,
    read_date DATETIME NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_to_read_date (to_user_id, is_read, reg_date),
    INDEX idx_from_date (from_user_id, reg_date),

    FOREIGN KEY (from_user_id) REFERENCES `user`(id) ON DELETE CASCADE,
    FOREIGN KEY (to_user_id)   REFERENCES `user`(id) ON DELETE CASCADE
);


# REPORT - 신고 접수 테이블
CREATE TABLE report (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    reporter_user_id INT UNSIGNED NOT NULL,
    target_type ENUM('USER', 'SONG', 'COMMENT') NOT NULL,
    target_id BIGINT UNSIGNED NOT NULL,
    reason_code VARCHAR(30) NOT NULL,
    `description` TEXT,
    `status` ENUM('PENDING', 'RESOLVED', 'REJECTED') NOT NULL DEFAULT 'PENDING',
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_report_pending (reporter_user_id, target_type, target_id, reason_code, `status`),
    FOREIGN KEY (reporter_user_id) REFERENCES `user`(id) ON DELETE CASCADE
);


# REPORT ACTION - 관리자 신고 처리 테이블
CREATE TABLE report_action (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    report_id BIGINT UNSIGNED NOT NULL,
    admin_id INT UNSIGNED NULL,
    # wanr = 경고, block = 차단, delete_content = 삭제, ignore = 보류
    action_type ENUM('WARN','BLOCK','DELETE_CONTENT','IGNORE') NOT NULL,
    action_reason TEXT,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE,
    FOREIGN KEY (admin_id) REFERENCES `user`(id) ON DELETE SET NULL
);


# REPORT TARGET SNAPSHOT - 신고 내역 기록 테이블
CREATE TABLE report_target_snapshot (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    report_id BIGINT UNSIGNED NOT NULL,
    target_name VARCHAR(100) NOT NULL,
    target_extra JSON,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE
);


# 관리자 권한 부여
UPDATE `user` SET `role` = 'BLOCK' WHERE id = 2;