CREATE DATABASE Vbeat;
USE Vbeat;

CREATE TABLE `User`(
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,email VARCHAR(100) NOT NULL
    ,loginPw VARCHAR(255) NULL
    ,nickName VARCHAR(50) NOT NULL
    ,loginType TINYINT NOT NULL DEFAULT 0 COMMENT '0=μΌλ°, 1=μΉ΄μΉ΄μ¤, 2=κµ¬κΈ€'
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,profileImg VARCHAR(255) NULL
    ,UNIQUE KEY (email)
    ,UNIQUE KEY (nickName)
);


# μ¶”ν›„ μ»¬λΌ μμ • 
CREATE TABLE Message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,channelId INT UNSIGNED NOT NULL 
    ,userId  INT UNSIGNED
    ,content TEXT NOT NULL 
    ,`type` INT UNSIGNED DEFAULT 0 # 0=μΌλ°, 1=μ‹μ¤ν…, 2=νμΌ, 3=Git, 4=μ½”λ“
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,FOREIGN KEY (channelId) REFERENCES `Channel`(id) ON DELETE CASCADE
    ,FOREIGN KEY (userId) REFERENCES `User`(id) ON DELETE SET NULL
)


CREATE TABLE song(
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    artist VARCHAR(100) NOT NULL,
    duration VARCHAR(200) NOT NULL,
    diff ENUM('easy','normal','hard','hell') NOT NULL DEFAULT 'normal',
    file_path VARCHAR(500) NULL,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    cover_path VARCHAR(500) NULL,
    is_public boolean not null default false
);
select * from song;

drop table song;

UPDATE song
   SET is_public = TRUE
 WHERE id = 9; 
 
SELECT note_time, lane, type, end_time, COUNT(*)
FROM note
WHERE song_id = 1
GROUP BY note_time, lane, type, end_time
HAVING COUNT(*) > 1;


CREATE TABLE note (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    song_id BIGINT UNSIGNED NOT NULL,
    note_time DECIMAL(10,3) NOT NULL,   -- Flaskμ—μ„ 3μλ¦¬λ΅ λΌμ΄λ”©λ time
    lane TINYINT UNSIGNED NOT NULL,
    `type` ENUM('tap', 'long') NOT NULL DEFAULT 'tap',
    end_time DECIMAL(10,3) NULL,        -- longλ§ μ‚¬μ©, tapμ€ NULL
    -- tap/end_time NULL λ¬Έμ  ν•΄κ²°μ© (μ¤‘λ³µ λ°©μ§€ ν•µμ‹¬)
    end_time_nn DECIMAL(10,3)
        GENERATED ALWAYS AS (IFNULL(end_time, -1.000)) STORED,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    -- μ΅°νμ© μΈλ±μ¤
    INDEX idx_song_time (song_id, note_time),
    INDEX idx_song_end (song_id, end_time),
    -- π”’ μµμΆ… μ¤‘λ³µ μ°¨λ‹¨ (κ°™μ€ μ‹κ°/λ μΈ/νƒ€μ… λ…ΈνΈ μ λ€ λ¶κ°€)
    UNIQUE KEY uq_note_dedup (song_id, note_time, lane, `type`, end_time_nn)
);

drop table note

select * from note;