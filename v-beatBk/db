CREATE DATABASE Vbeat;
USE Vbeat;

CREATE TABLE `user`(
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,email VARCHAR(100) NOT NULL
    ,loginPw VARCHAR(255) NULL
    ,nickName VARCHAR(50) NOT NULL
    ,loginType TINYINT NOT NULL DEFAULT 0 COMMENT '0=ÏùºÎ∞ò, 1=Ïπ¥Ïπ¥Ïò§, 2=Íµ¨Í∏Ä'
    ,socialId VARCHAR(80) NULL
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,profileImg VARCHAR(255) NULL
    ,UNIQUE KEY (email)
    ,UNIQUE KEY (nickName)
);

INSERT INTO `user`
(email, loginPw, nickName, loginType)
VALUES
(
  'test@vbeat.com',
  '$2a$10$7a9pQZ2lYpF2B4bXjZ2n9uM6lUQmZbJZJ6pZq5J6JrGkQ0gKx1q1e',
  'ÌÖåÏä§Ìä∏Ïú†Ï†Ä',
  0
);

DROP TABLE `user`;
SELECT * FROM `user`;

# Ï∂îÌõÑ Ïª¨Îüº ÏàòÏ†ï 
CREATE TABLE Message (
    id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT 
    ,channelId INT UNSIGNED NOT NULL 
    ,userId  INT UNSIGNED
    ,content TEXT NOT NULL 
    ,`type` INT UNSIGNED DEFAULT 0 # 0=ÏùºÎ∞ò, 1=ÏãúÏä§ÌÖú, 2=ÌååÏùº, 3=Git, 4=ÏΩîÎìú
    ,regDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    ,FOREIGN KEY (channelId) REFERENCES `Channel`(id) ON DELETE CASCADE
    ,FOREIGN KEY (userId) REFERENCES `User`(id) ON DELETE SET NULL
)


# ÏùåÏõê Í¥ÄÎ†® ÌÖåÏù¥Î∏î
CREATE TABLE song(
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    artist VARCHAR(100) NOT NULL,
    duration VARCHAR(200) NOT NULL,
    diff ENUM('easy','normal','hard','hell') NOT NULL DEFAULT 'normal',
    file_path VARCHAR(500) NULL,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    cover_path VARCHAR(500) NULL,
    preview_path VARCHAR(500) NULL,
    is_public BOOLEAN NOT NULL DEFAULT FALSE
);

SELECT * FROM song;
DROP TABLE song;

UPDATE song
   SET is_public = TRUE
 WHERE id IN (5); 
 
SELECT note_time, lane, TYPE, end_time, COUNT(*)
FROM note
WHERE song_id = 6
GROUP BY note_time, lane, TYPE, end_time
HAVING COUNT(*) > 1;


# ÏùåÏõêÎ∂ÑÏÑù ÌõÑ ÎÖ∏Ìä∏ Ï†ÄÏû• ÌÖåÏù¥Î∏î
CREATE TABLE note (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    song_id BIGINT UNSIGNED NOT NULL,
    note_time DECIMAL(10,3) NOT NULL,   -- FlaskÏóêÏÑú 3ÏûêÎ¶¨Î°ú ÎùºÏö¥Îî©Îêú time
    lane TINYINT UNSIGNED NOT NULL,
    `type` ENUM('tap', 'long') NOT NULL DEFAULT 'tap',
    end_time DECIMAL(10,3) NULL,        -- longÎßå ÏÇ¨Ïö©, tapÏùÄ NULL
    -- tap/end_time NULL Î¨∏Ï†ú Ìï¥Í≤∞Ïö© (Ï§ëÎ≥µ Î∞©ÏßÄ ÌïµÏã¨)
    end_time_nn DECIMAL(10,3)
        GENERATED ALWAYS AS (IFNULL(end_time, -1.000)) STORED,
    create_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    -- Ï°∞ÌöåÏö© Ïù∏Îç±Ïä§
    INDEX idx_song_time (song_id, note_time),
    INDEX idx_song_end (song_id, end_time),
    -- üîí ÏµúÏ¢Ö Ï§ëÎ≥µ Ï∞®Îã® (Í∞ôÏùÄ ÏãúÍ∞Å/Î†àÏù∏/ÌÉÄÏûÖ ÎÖ∏Ìä∏ Ï†àÎåÄ Î∂àÍ∞Ä)
    UNIQUE KEY uq_note_dedup (song_id, note_time, lane, `type`, end_time_nn)
);

DROP TABLE note
SELECT * FROM note;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# Ï†êÏàò Ï†ÄÏû• ÌÖåÏù¥Î∏î(Îû≠ÌÇπÏãúÏä§ÌÖú)
CREATE TABLE score (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NULL,  #Ï∂îÌõÑ Î°úÍ∑∏Ïù∏ Í∏∞Îä• Íµ¨ÌòÑ Ïãú not nullÎ°ú Î≥ÄÍ≤Ω
    song_id BIGINT UNSIGNED NOT NULL,
    diff VARCHAR(10) NOT NULL,
    score INT NOT NULL,
    accuracy DECIMAL(5,2) NOT NULL,
    grade CHAR(1) NOT NULL,
    max_combo INT NOT NULL,
    reg_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_rank (song_id, diff, score, accuracy, max_combo, reg_date),
    INDEX idx_user (user_id, song_id, diff)
);

SELECT * FROM score;
DROP TABLE score;